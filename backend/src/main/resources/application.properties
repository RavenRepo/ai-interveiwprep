# ═══════════════════════════════════════════════════════════════
# AI Interview Preparation Platform — Application Configuration
# ═══════════════════════════════════════════════════════════════
# SECURITY POLICY: No default values for secrets.
# Spring Boot will FAIL TO START if required env vars are missing.
# See .env.example for the full list of required variables.
# ═══════════════════════════════════════════════════════════════

# ─── Server ───────────────────────────────────────────────────
server.port=${SERVER_PORT:8080}

# ─── Virtual Threads (Java 21) ────────────────────────────────
# Tomcat handles each request on a virtual thread instead of a
# platform thread. Thread.sleep() in polling loops (D-ID,
# AssemblyAI) yields the carrier thread back to the pool.
spring.threads.virtual.enabled=true

# ─── Database ─────────────────────────────────────────────────
spring.datasource.url=jdbc:mysql://${DB_HOST:localhost}:${DB_PORT:3306}/${DB_NAME:interview_platform}
spring.datasource.username=${DB_USER}
spring.datasource.password=${DB_PASSWORD}
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

# ─── HikariCP Connection Pool ────────────────────────────────
# Virtual threads can spawn thousands of concurrent tasks.
# Without tuning, they will exhaust the default pool (10) and
# cause SQLTransientConnectionException cascades.
spring.datasource.hikari.maximum-pool-size=${HIKARI_MAX_POOL:30}
spring.datasource.hikari.minimum-idle=${HIKARI_MIN_IDLE:10}
spring.datasource.hikari.connection-timeout=20000
spring.datasource.hikari.idle-timeout=300000
spring.datasource.hikari.max-lifetime=900000
spring.datasource.hikari.leak-detection-threshold=60000

# ─── JPA / Hibernate ─────────────────────────────────────────
# ddl-auto=validate ensures Hibernate checks the schema matches
# entities at startup but NEVER modifies the database.
# Flyway owns all schema changes.
spring.jpa.hibernate.ddl-auto=${JPA_DDL_AUTO:validate}
spring.jpa.show-sql=${JPA_SHOW_SQL:false}
spring.jpa.properties.hibernate.format_sql=true
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.MySQLDialect

# ─── Flyway Database Migrations ──────────────────────────────
spring.flyway.enabled=true
spring.flyway.locations=classpath:db/migration
# baseline-on-migrate=true allows Flyway to adopt an existing
# database that was previously managed by ddl-auto=update.
# It records the current state as "version 0" and applies
# subsequent migrations from V1 onward.
spring.flyway.baseline-on-migrate=true
spring.flyway.baseline-version=0

# ─── File Upload ──────────────────────────────────────────────
# Note: These limits apply until the P1 presigned-URL migration
# removes server-proxied uploads entirely.
spring.servlet.multipart.max-file-size=${UPLOAD_MAX_FILE_SIZE:100MB}
spring.servlet.multipart.max-request-size=${UPLOAD_MAX_REQUEST_SIZE:100MB}

# ─── AWS S3 ───────────────────────────────────────────────────
# In production (EC2/ECS/EKS), prefer IAM roles and leave
# AWS_ACCESS_KEY_ID / AWS_SECRET_ACCESS_KEY blank or unset.
# The DefaultCredentialsProvider chain in S3Config.java will
# automatically discover IAM role credentials from the instance
# profile, ECS task role, or IRSA (EKS).
aws.access.key.id=${AWS_ACCESS_KEY_ID:}
aws.secret.access.key=${AWS_SECRET_ACCESS_KEY:}
aws.s3.bucket.name=${AWS_S3_BUCKET_NAME}
aws.region=${AWS_REGION:us-east-1}

# ─── S3 Presigned URL Durations (P1) ─────────────────────────
# GET URLs are generated on-demand when building DTOs for the
# frontend. They replace the old approach of storing 7-day
# presigned URLs in the database (which expired and broke
# archived interview playback).
#
# PUT URLs are used for the direct-to-S3 upload flow. The
# frontend uploads video response files directly to S3 via
# presigned PUT, bypassing the backend server entirely.
aws.s3.presigned.get.duration-minutes=${S3_PRESIGNED_GET_MINUTES:60}
aws.s3.presigned.put.duration-minutes=${S3_PRESIGNED_PUT_MINUTES:15}

# ─── JWT Authentication ──────────────────────────────────────
# NO DEFAULT — fail fast if missing. The previously hardcoded
# secret has been removed and MUST be rotated.
app.jwtSecret=${JWT_SECRET}
app.jwtExpirationInMs=${JWT_EXPIRATION:3600000}

# ─── OpenAI (GPT) ────────────────────────────────────────────
openai.api.key=${OPENAI_API_KEY}
openai.model=${OPENAI_MODEL:gpt-4o}
openai.max-tokens=${OPENAI_MAX_TOKENS:2000}
openai.temperature=${OPENAI_TEMPERATURE:0.7}

# ─── ElevenLabs (Text-to-Speech) ──────────────────────────────
elevenlabs.api.key=${ELEVENLABS_API_KEY}
elevenlabs.api.url=https://api.elevenlabs.io/v1
elevenlabs.voice.id=${ELEVENLABS_VOICE_ID:21m00Tcm4TlvDq8ikWAM}
elevenlabs.model.id=${ELEVENLABS_MODEL_ID:eleven_monolingual_v1}
elevenlabs.voice.stability=${ELEVENLABS_VOICE_STABILITY:0.5}
elevenlabs.voice.similarity-boost=${ELEVENLABS_SIMILARITY_BOOST:0.75}

# ─── D-ID (Avatar Video Generation) ──────────────────────────
did.api.key=${DID_API_KEY}
did.api.url=https://api.d-id.com
did.avatar.image.url=${DID_AVATAR_IMAGE_URL:https://d-id-public-bucket.s3.us-west-2.amazonaws.com/alice.jpg}

# ─── AssemblyAI (Speech-to-Text) ─────────────────────────────
assemblyai.api.key=${ASSEMBLYAI_API_KEY}
assemblyai.api.url=https://api.assemblyai.com/v2

# ─── Spring Boot Actuator ────────────────────────────────────
# Expose only the health endpoint. Details require ADMIN role.
# Previously: /actuator/** was permitAll() with show-details=always,
# leaking DB connection status and disk info to anonymous users.
management.endpoints.web.exposure.include=health,info
management.endpoint.health.show-details=when_authorized
management.endpoint.health.roles=ADMIN
management.endpoint.info.enabled=true
management.info.env.enabled=false

# ─── CORS ─────────────────────────────────────────────────────
# Comma-separated list of allowed origins for the frontend.
# SecurityConfig.java reads this value.
app.cors.allowed-origins=${CORS_ALLOWED_ORIGINS:http://localhost:3000}

# ═══════════════════════════════════════════════════════════════
# P1 — Resilience4j Configuration
# ═══════════════════════════════════════════════════════════════
# Programmatic retry and circuit breaker instances are created
# in ResilienceConfig.java using these values. Named instances:
#   openai, elevenlabs, did, assemblyai
#
# The manual retry loops that were previously in each service
# (AvatarVideoService, TextToSpeechService, etc.) have been
# replaced with Resilience4j decorators that provide:
#   - Configurable exponential backoff
#   - Circuit breaker protection against sustained outages
#   - Observable metrics via /actuator (when exposed)
#
# IMPORTANT: Polling loops (D-ID video status, AssemblyAI
# transcription status) are NOT wrapped with Resilience4j.
# Polling checks async job progress — it is NOT a retry.

# ─── Retry ────────────────────────────────────────────────────
resilience4j.retry.max-attempts=${RESILIENCE4J_RETRY_MAX_ATTEMPTS:3}
resilience4j.retry.wait-duration-ms=${RESILIENCE4J_RETRY_WAIT_MS:1000}
resilience4j.retry.exponential-backoff-multiplier=${RESILIENCE4J_RETRY_BACKOFF:2.0}

# ─── Circuit Breaker ─────────────────────────────────────────
# When failure rate exceeds threshold over the sliding window,
# the circuit opens and subsequent calls fail fast for the
# wait duration. This prevents hammering degraded services.
resilience4j.circuitbreaker.failure-rate-threshold=${CB_FAILURE_RATE_THRESHOLD:50}
resilience4j.circuitbreaker.slow-call-duration-seconds=${CB_SLOW_CALL_SECONDS:30}
resilience4j.circuitbreaker.slow-call-rate-threshold=${CB_SLOW_CALL_RATE:80}
resilience4j.circuitbreaker.sliding-window-size=${CB_SLIDING_WINDOW_SIZE:10}
resilience4j.circuitbreaker.minimum-number-of-calls=${CB_MINIMUM_CALLS:5}
resilience4j.circuitbreaker.wait-duration-open-state-seconds=${CB_WAIT_OPEN_SECONDS:60}
resilience4j.circuitbreaker.permitted-calls-half-open=${CB_HALF_OPEN_CALLS:3}

# ═══════════════════════════════════════════════════════════════
# P1 — Rate Limiting (Bucket4j)
# ═══════════════════════════════════════════════════════════════
# Per-user token-bucket rate limiting applied to expensive
# endpoints via RateLimitInterceptor (registered in WebMvcConfig).
#
# Protected endpoints:
#   POST /api/interviews/start     (~$0.53 per call in API fees)
#   POST /api/interviews/*/complete (~$0.02 per call)
#   POST /api/resumes/upload       (S3 upload + CPU-intensive parsing)
#
# A user can burst up to `capacity` requests, then must wait for
# tokens to refill at `refill-tokens` per `refill-period-seconds`.
app.rate-limit.capacity=${RATE_LIMIT_CAPACITY:5}
app.rate-limit.refill-tokens=${RATE_LIMIT_REFILL_TOKENS:5}
app.rate-limit.refill-period-seconds=${RATE_LIMIT_REFILL_SECONDS:60}

# ═══════════════════════════════════════════════════════════════
# P1 — Interview Recovery Task
# ═══════════════════════════════════════════════════════════════
# Scheduled task that detects interviews stuck in transient
# states (GENERATING_VIDEOS, PROCESSING) and recovers them.
#
# GENERATING_VIDEOS → IN_PROGRESS (text-only fallback)
#   after video-generation-timeout-minutes (default: 15 min)
#
# PROCESSING → FAILED
#   after processing-timeout-minutes (default: 30 min)
#
# The task runs at fixed delay (not fixed rate) to prevent
# overlap if a sweep takes longer than the interval.
app.recovery.interval-ms=${RECOVERY_INTERVAL_MS:300000}
app.recovery.initial-delay-ms=${RECOVERY_INITIAL_DELAY_MS:60000}
app.recovery.video-generation-timeout-minutes=${RECOVERY_VIDEO_TIMEOUT_MIN:15}
app.recovery.processing-timeout-minutes=${RECOVERY_PROCESSING_TIMEOUT_MIN:30}

# ─── Logging ──────────────────────────────────────────────────
logging.level.root=INFO
logging.level.com.interview.platform=INFO
logging.level.org.hibernate.SQL=${LOG_HIBERNATE_SQL:WARN}
logging.level.org.flywaydb=INFO
logging.level.com.zaxxer.hikari=INFO
logging.level.io.github.resilience4j=INFO
