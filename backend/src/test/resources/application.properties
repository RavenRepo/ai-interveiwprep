# ═══════════════════════════════════════════════════════════════
# Test Profile — application.properties
# ═══════════════════════════════════════════════════════════════
# Provides safe defaults for all externalized properties so that
# unit tests (which use @ExtendWith(MockitoExtension.class) and
# do NOT boot a full Spring context) and integration tests
# (which DO boot Spring) can run without real environment variables.
#
# No real API calls are made during tests — all external services
# are mocked. These values exist solely to satisfy Spring Boot's
# property resolution so the context starts without errors.
# ═══════════════════════════════════════════════════════════════

# ─── Server ───────────────────────────────────────────────────
server.port=0

# ─── Virtual Threads ──────────────────────────────────────────
spring.threads.virtual.enabled=true

# ─── Database (H2 in-memory for tests) ───────────────────────
# Tests use H2 instead of MySQL to avoid requiring a running
# database instance. The MySQL Flyway dependency is not compatible
# with H2, so Flyway is disabled for tests and Hibernate manages
# the schema directly via ddl-auto=create-drop.
spring.datasource.url=jdbc:h2:mem:testdb;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE;MODE=MYSQL
spring.datasource.username=sa
spring.datasource.password=
spring.datasource.driver-class-name=org.h2.Driver

# ─── JPA / Hibernate ─────────────────────────────────────────
spring.jpa.hibernate.ddl-auto=create-drop
spring.jpa.show-sql=false
spring.jpa.properties.hibernate.format_sql=false
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.H2Dialect
spring.jpa.defer-datasource-initialization=false

# ─── Flyway (disabled for tests — H2 is not MySQL) ───────────
spring.flyway.enabled=false

# ─── HikariCP (small pool for tests) ─────────────────────────
spring.datasource.hikari.maximum-pool-size=5
spring.datasource.hikari.minimum-idle=1
spring.datasource.hikari.connection-timeout=10000

# ─── File Upload ──────────────────────────────────────────────
spring.servlet.multipart.max-file-size=10MB
spring.servlet.multipart.max-request-size=10MB

# ─── JWT Authentication ──────────────────────────────────────
# Test-only secret. 64 bytes minimum for HS512.
# This key is NOT used in any real environment.
app.jwtSecret=test-jwt-secret-key-that-is-long-enough-for-hs512-algorithm-validation-requirements-64bytes!!
app.jwtExpirationInMs=3600000

# ─── AWS S3 (mocked in tests — these values are never used) ──
aws.access.key.id=test-access-key
aws.secret.access.key=test-secret-key
aws.s3.bucket.name=test-bucket
aws.region=us-east-1

# ─── OpenAI (mocked in tests) ────────────────────────────────
openai.api.key=sk-test-placeholder-key
openai.model=gpt-4o
openai.max-tokens=2000
openai.temperature=0.7

# ─── ElevenLabs (mocked in tests) ────────────────────────────
elevenlabs.api.key=test-elevenlabs-key
elevenlabs.api.url=https://api.elevenlabs.io/v1
elevenlabs.voice.id=21m00Tcm4TlvDq8ikWAM
elevenlabs.model.id=eleven_monolingual_v1
elevenlabs.voice.stability=0.5
elevenlabs.voice.similarity-boost=0.75

# ─── D-ID (mocked in tests) ──────────────────────────────────
did.api.key=test-did-key
did.api.url=https://api.d-id.com
did.avatar.image.url=https://example.com/test-avatar.jpg

# ─── AssemblyAI (mocked in tests) ────────────────────────────
assemblyai.api.key=test-assemblyai-key
assemblyai.api.url=https://api.assemblyai.com/v2

# ─── S3 Presigned URL Durations (P1) ─────────────────────────
# Short durations for tests — these values are never actually
# used because S3 operations are mocked, but they must be
# present to satisfy property resolution.
aws.s3.presigned.get.duration-minutes=60
aws.s3.presigned.put.duration-minutes=15

# ─── CORS ─────────────────────────────────────────────────────
app.cors.allowed-origins=http://localhost:3000

# ─── Resilience4j (P1 — fast retries for tests) ──────────────
# Minimal retry settings so tests fail/succeed quickly without
# long exponential backoff waits. Circuit breaker is configured
# with high thresholds to avoid tripping during test runs.
resilience4j.retry.max-attempts=2
resilience4j.retry.wait-duration-ms=100
resilience4j.retry.exponential-backoff-multiplier=1.5

resilience4j.circuitbreaker.failure-rate-threshold=80
resilience4j.circuitbreaker.slow-call-duration-seconds=60
resilience4j.circuitbreaker.slow-call-rate-threshold=100
resilience4j.circuitbreaker.sliding-window-size=10
resilience4j.circuitbreaker.minimum-number-of-calls=10
resilience4j.circuitbreaker.wait-duration-open-state-seconds=5
resilience4j.circuitbreaker.permitted-calls-half-open=5

# ─── Rate Limiting (P1 — generous for tests) ─────────────────
# High capacity so tests don't get rate-limited unexpectedly.
app.rate-limit.capacity=100
app.rate-limit.refill-tokens=100
app.rate-limit.refill-period-seconds=60

# ─── Interview Recovery Task (P1 — short timeouts for tests) ─
# Short timeouts so integration tests can verify recovery behavior
# without waiting 15+ minutes.
app.recovery.interval-ms=60000
app.recovery.initial-delay-ms=5000
app.recovery.video-generation-timeout-minutes=1
app.recovery.processing-timeout-minutes=2

# ─── Actuator (minimal for tests) ────────────────────────────
management.endpoints.web.exposure.include=health
management.endpoint.health.show-details=never

# ─── Logging (quiet for tests) ────────────────────────────────
logging.level.root=WARN
logging.level.com.interview.platform=WARN
logging.level.org.hibernate.SQL=WARN
logging.level.org.springframework.security=WARN
logging.level.com.zaxxer.hikari=WARN
logging.level.io.github.resilience4j=WARN
